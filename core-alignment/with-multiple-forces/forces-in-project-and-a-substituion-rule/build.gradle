apply plugin: 'groovy'

repositories {
    maven {
        url 'repo'
    }
}

configurations.all {
    resolutionStrategy {
        force 'apricot:apricot-apache:4.0.0'
        force 'apricot:apricot-aws:4.0.0'
        force 'apricot:apricot-core:4.0.0'
    }
}

project.dependencies.components.all(AlignGroup.class)
class AlignGroup implements ComponentMetadataRule {
    void execute(ComponentMetadataContext ctx) {
        ctx.details.with { it ->
            if (it.getId().getGroup().startsWith("apricot")) {
                it.belongsTo("aligned-platform:apricot:${it.getId().getVersion()}")
            }
        }
    }
}

import org.gradle.api.internal.artifacts.ivyservice.ivyresolve.strategy.*

def VERSIONED_COMPARATOR = new DefaultVersionComparator()
def VERSION_COMPARATOR = VERSIONED_COMPARATOR.asVersionComparator()
def VERSION_SCHEME = new DefaultVersionSelectorScheme(VERSIONED_COMPARATOR)

configurations.all {
    resolutionStrategy.dependencySubstitution.all {
        def substituteFromVersion = "2.0.0"
        def substituteToVersion = "3.0.0"
        def substitutionReason = "substitution from '${it.requested.group}:${it.requested.module}:$substituteFromVersion' to '${it.requested.group}:${it.requested.module}:$substituteToVersion'"
        def selector = VERSION_SCHEME.parseSelector(substituteFromVersion)
        if (it.requested.group.startsWith("apricot") && it.requested.module.equals("apricot-core") && selector.accept(it.requested.version)) {
            it.useTarget("${it.requested.group}:${it.requested.module}:${substituteToVersion}", substitutionReason)
        }
    }
}

dependencies {
    implementation 'test.nebula:b:1.0.0' // brings apricot dependencies 2.0.0
    implementation 'test.nebula:d:1.0.0' // brings apricot dependencies 4.0.0
    implementation 'test.nebula:e:1.0.0' // brings apricot dependencies 5.0.0
}
